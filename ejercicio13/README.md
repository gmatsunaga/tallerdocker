# Ejercicio 13

## Aplicando Descriptor de Kubernetes para ConfigMap
Para aplicar el descriptor de Kubernetes, ejecutamos:

    kubectl apply -f jobvacancyconfig.yml

y luego para verificar revisamos con el comando 

    kubectl get configmap

Que retorna el configmap creado:

    NAME               DATA   AGE
    jobvacancyconfig   2      4s
    kube-root-ca.crt   1      92s

## Aplicando Descriptor de Kubernetes para Secret
Para aplicar el descriptor de Kubernetes, ejecutamos:

    kubectl apply -f jobvacancysecret.yml

y luego para verificar revisamos con el comando 

    kubectl get secret

que retorna el secret creado: 

    NAME               TYPE     DATA   AGE
    jobvacancysecret   Opaque   1      6s

## Iniciando un POD Postgre
Para iniciar un POD de postgre y exponer un servicio de clusterip, ejecutamos:

    kubectl run db --image=postgres:10.4 --env="POSTGRES_PASSWORD=Passw0rd!" --port=5432 --expose

y luego para verificar revisamos con el comando 

    kubectl get all

que retorna el pod y el servicio creado: 

    NAME     READY   STATUS              RESTARTS   AGE
    pod/db   0/1     ContainerCreating   0          4s

    NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
    service/db           ClusterIP   10.104.129.137   <none>        5432/TCP   4s
    service/kubernetes   ClusterIP   10.96.0.1        <none>        443/TCP    3m24s


## Aplicando Descriptor de Kubernetes para Deployment de JobVacancy
Para aplicar el descriptor de Kubernetes, ejecutamos:

    kubectl apply -f web_deployment.yaml

## Verificar el funcionamiento 
Para verificar ejecutamos:

    kubectl get all

y nos retorna las el replicas set:

    NAME                         READY   UP-TO-DATE   AVAILABLE   AGE
    deployment.apps/jobvacancy   1/1     1            1           8m19s

    NAME                                    DESIRED   CURRENT   READY   AGE       
    replicaset.apps/jobvacancy-66f9749d79   1         1         1       8m19s     

    NAME                              READY   STATUS    RESTARTS   AGE
    pod/db                            1/1     Running   0          10m
    pod/jobvacancy-66f9749d79-jl26z   1/1     Running   0          8m19s

    NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
    service/db           ClusterIP   10.104.129.137   <none>        5432/TCP   10m
    service/kubernetes   ClusterIP   10.96.0.1        <none>        443/TCP    13m


y si inspeccionamos el pod de jobvacancy, viendo sus logs vemos que corrio la migracion:

    I, [2022-08-13T02:20:50.273828 #7]  INFO -- : Finished applying migration version 6, direction: up, took 0.022790 seconds
    I, [2022-08-13T02:20:50.273847 #7]  INFO -- : Begin applying migration version 7, direction: up
    I, [2022-08-13T02:20:50.274074 #7]  INFO -- : (0.000175s) BEGIN
    I, [2022-08-13T02:20:50.325334 #7]  INFO -- : (0.050949s) CREATE TABLE "pings" ("id" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, "description" text, "created_at" timestamp)
    I, [2022-08-13T02:20:50.327097 #7]  INFO -- : (0.001129s) UPDATE "schema_info" SET "version" = 7
    I, [2022-08-13T02:20:50.334299 #7]  INFO -- : (0.006848s) COMMIT
    I, [2022-08-13T02:20:50.334527 #7]  INFO -- : Finished applying migration version 7, direction: up, took 0.060658 seconds
    I, [2022-08-13T02:20:50.334592 #7]  INFO -- : Begin applying migration version 8, direction: up
    I, [2022-08-13T02:20:50.335589 #7]  INFO -- : (0.000790s) BEGIN
    I, [2022-08-13T02:20:50.337388 #7]  INFO -- : (0.001191s) ALTER TABLE "users" ADD COLUMN "created_on" date
    I, [2022-08-13T02:20:50.338472 #7]  INFO -- : (0.000736s) ALTER TABLE "users" ADD COLUMN "updated_on" date
    I, [2022-08-13T02:20:50.339340 #7]  INFO -- : (0.000644s) UPDATE "schema_info" SET "version" = 8
    I, [2022-08-13T02:20:50.370180 #7]  INFO -- : (0.030701s) COMMIT
    I, [2022-08-13T02:20:50.370293 #7]  INFO -- : Finished applying migration version 8, direction: up, took 0.035704 seconds
    <= sq:migrate:up executed
    I, [2022-08-13T02:20:52.259815 #9]  INFO -- : (0.000581s) SELECT CAST(current_setting('server_version_num') AS integer) AS v
    I, [2022-08-13T02:20:52.265317 #9]  INFO -- : (0.004425s) SELECT "pg_attribute"."attname" AS "name", CAST("pg_attribute"."atttypid" AS integer) AS "oid", CAST("basetype"."oid" AS integer) AS 
    "base_oid", format_type("basetype"."oid", "pg_type"."typtypmod") AS "db_base_type", format_type("pg_type"."oid", "pg_attribute"."atttypmod") AS "db_type", pg_get_expr("pg_attrdef"."adbin", "pg_class"."oid") AS "default", NOT "pg_attribute"."attnotnull" AS "allow_null", COALESCE(("pg_attribute"."attnum" = ANY("pg_index"."indkey")), false) AS "primary_key", "pg_attribute"."attidentity" FROM "pg_class" INNER JOIN "pg_attribute" ON ("pg_attribute"."attrelid" = "pg_class"."oid") INNER JOIN "pg_type" ON ("pg_type"."oid" = "pg_attribute"."atttypid") LEFT OUTER JOIN "pg_type" AS "basetype" ON ("basetype"."oid" = "pg_type"."typbasetype") LEFT OUTER JOIN "pg_attrdef" ON (("pg_attrdef"."adrelid" = "pg_class"."oid") AND ("pg_attrdef"."adnum" = "pg_attribute"."attnum")) LEFT OUTER JOIN "pg_index" ON (("pg_index"."indrelid" = "pg_class"."oid") AND ("pg_index"."indisprimary" IS TRUE)) WHERE (("pg_attribute"."attisdropped" IS FALSE) AND ("pg_attribute"."attnum" > 0) AND ("pg_class"."oid" = CAST(CAST('"pings"' AS regclass) AS oid))) ORDER BY "pg_attribute"."attnum"
    